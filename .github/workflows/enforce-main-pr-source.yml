name: Enforce Main PR Source

# CRITICAL: main branch must ONLY accept PRs from dev branch
# Feature/fix branches ‚Üí dev ‚Üí main (never feature ‚Üí main)
# This workflow enforces the three-tier branching strategy

on:
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened, edited]

jobs:
  validate-source-branch:
    runs-on: ubuntu-latest
    steps:
      - name: Check PR source branch
        run: |
          SOURCE_BRANCH="${{ github.head_ref }}"
          TARGET_BRANCH="${{ github.base_ref }}"

          echo "üìã PR Source: $SOURCE_BRANCH"
          echo "üìã PR Target: $TARGET_BRANCH"

          if [ "$TARGET_BRANCH" = "main" ] && [ "$SOURCE_BRANCH" != "dev" ]; then
            echo ""
            echo "‚ùå ERROR: main branch only accepts PRs from dev branch"
            echo ""
            echo "Current PR: $SOURCE_BRANCH ‚Üí main (REJECTED)"
            echo "Required:   dev ‚Üí main"
            echo ""
            echo "To fix this:"
            echo "1. Close this PR"
            echo "2. Change base branch to dev:"
            echo "   gh pr create --base dev --head $SOURCE_BRANCH"
            echo "3. Merge to dev first (deploys to staging for testing)"
            echo "4. After staging tests pass, create dev ‚Üí main PR for production release"
            echo ""
            echo "See DEVELOPMENT.md ¬ß Git Branching Strategy for complete workflow"
            exit 1
          fi

          echo "‚úÖ Valid PR source: $SOURCE_BRANCH ‚Üí $TARGET_BRANCH"
          echo "This PR follows the three-tier branching strategy"
